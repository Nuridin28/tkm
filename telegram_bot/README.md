# Telegram Bot для Help Desk

Telegram бот для приема обращений от пользователей с интеграцией в систему Help Desk.

## Возможности

- ✅ Сбор контактной информации (телефон, email, имя)
- ✅ Определение типа лица (физическое/юридическое)
- ✅ Интеграция с RAG/AI системой для анализа обращений
- ✅ Автоматический ответ на простые вопросы
- ✅ Создание тикетов для сложных вопросов
- ✅ Автоматическая классификация и маршрутизация

## Установка

1. **Создайте виртуальное окружение и установите зависимости:**
   ```bash
   cd telegram_bot
   python3 -m venv venv
   source venv/bin/activate  # На Windows: venv\Scripts\activate
   pip install -r requirements.txt
   ```
   
   **Важно:** Бот использует отдельное виртуальное окружение, чтобы избежать конфликтов зависимостей с backend (особенно httpx).

2. **Создайте бота в Telegram:**
   - Откройте [@BotFather](https://t.me/BotFather)
   - Отправьте команду `/newbot`
   - Следуйте инструкциям и получите токен бота

3. **Настройте переменные окружения:**
   ```bash
   cp .env.example .env
   ```
   
   Отредактируйте `.env`:
   ```env
   TELEGRAM_BOT_TOKEN=your_bot_token_from_botfather
   API_URL=http://localhost:8000
   TELEGRAM_BOT_API_KEY=your_secret_api_key_for_backend_auth
   ```

4. **Настройте backend:**
   
   Добавьте в `backend/.env`:
   ```env
   TELEGRAM_BOT_API_KEY=your_secret_api_key_for_backend_auth
   ```
   
   Этот ключ используется для аутентификации запросов от бота к backend.

## Запуск

**Важно:** Используйте виртуальное окружение для избежания конфликтов зависимостей.

```bash
# Активируйте виртуальное окружение
source venv/bin/activate  # На Windows: venv\Scripts\activate

# Запустите бота
python3 bot.py
```

**Или используйте скрипт:**
```bash
./run.sh
```

## Использование

1. Пользователь отправляет команду `/start`
2. Бот запрашивает контактную информацию:
   - Номер телефона
   - Email (опционально)
   - Полное имя
   - Тип лица (физическое/юридическое)
3. Пользователь описывает проблему
4. Система анализирует обращение:
   - Если может ответить сразу → отправляет ответ
   - Если нет → создает тикет и уведомляет пользователя

## Структура проекта

```
telegram_bot/
├── bot.py              # Основной файл бота
├── api_client.py       # Клиент для API backend
├── models.py           # Модели данных
├── config.py           # Конфигурация
├── requirements.txt    # Зависимости
└── README.md          # Документация
```

## API Endpoints

Бот использует следующие endpoints backend:

- `POST /api/telegram/analyze` - Анализ сообщения через RAG/AI
- `POST /api/telegram/create-ticket` - Создание тикета

## Безопасность

- Все запросы от бота к backend защищены API ключом (`X-Telegram-API-Key`)
- Контактная информация хранится только в сессии бота и передается в backend
- В продакшене рекомендуется использовать более сложную систему аутентификации

## Разработка

Для разработки можно использовать:
- `python-telegram-bot` для работы с Telegram API
- `httpx` для HTTP запросов к backend
- `pydantic` для валидации данных

## Troubleshooting

**Бот не отвечает:**
- Проверьте токен бота в `.env`
- Убедитесь, что backend запущен и доступен по `API_URL`

**Ошибки при создании тикетов:**
- Проверьте `TELEGRAM_BOT_API_KEY` в обоих `.env` файлах
- Убедитесь, что backend endpoint `/api/telegram/create-ticket` доступен

**Ошибки анализа:**
- Проверьте, что OpenAI API ключ настроен в backend
- Убедитесь, что RAG система работает корректно

