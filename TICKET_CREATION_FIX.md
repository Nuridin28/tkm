# Исправления логики создания тикетов

## Проблемы, которые были найдены и исправлены

### 1. ❌ Проблема: Тикеты не создавались даже когда AI явно запрашивал

**Описание:**
В логике была проверка, которая отменяла создание тикета, даже если AI явно указал `[TICKET_REQUIRED]` с `NEEDS_TICKET: true`. Это происходило, если:
- Есть релевантная информация (similarity >= 0.2)
- Это не техническая проблема

**Исправление:**
- Добавлен флаг `ai_explicitly_requested_ticket` для отслеживания явного запроса от AI
- Если AI явно запросил тикет, он создается независимо от релевантности
- Тикет также создается если:
  - Релевантность < 20% (нет информации для ответа)
  - Это техническая проблема, требующая вмешательства
  - AI явно запросил тикет

### 2. ❌ Проблема: Данные из incoming_meta не использовались при создании тикета

**Описание:**
В `ticket_service.py` при создании тикета не использовались данные из `incoming_meta`:
- `category`, `subcategory` - не сохранялись
- `department` - не преобразовывался в `department_id`
- `priority` - всегда использовался `MEDIUM`, игнорируя значение из метаданных
- `language`, `summary` - не сохранялись

**Исправление:**
- Добавлено извлечение всех данных из `incoming_meta`
- `department` преобразуется в `department_id` через поиск в таблице `departments`
- Все поля сохраняются в тикет

### 3. ✅ Добавлено логирование

**Добавлено:**
- Логирование процесса принятия решения о создании тикета
- Логирование данных тикета перед созданием
- Логирование успешного создания или ошибок
- Все логи имеют префикс `[TICKET LOGIC]` или `[TICKET CREATION]` или `[TICKET_SERVICE]`

## Новая логика создания тикетов

Тикет создается если выполняется ЛЮБОЕ из условий:

1. **AI явно запросил тикет** (`[TICKET_REQUIRED]` с `NEEDS_TICKET: true`)
   - Создается независимо от релевантности информации

2. **Нет релевантной информации** (similarity < 0.2)
   - Нет информации в базе знаний для ответа

3. **Техническая проблема, требующая вмешательства**
   - Ключевые слова: роутер, модем, оборудование, диагностика, техническая проблема, помощь специалиста, требуется вмешательство, выезд, ремонт

Тикет НЕ создается если:
- Есть релевантная информация (similarity >= 0.2)
- Это НЕ техническая проблема
- AI НЕ запросил явно создание тикета

## Как проверить работу

1. **Проверьте логи backend:**
   ```bash
   # В логах вы увидите:
   [TICKET LOGIC] AI explicitly requested ticket: true/false
   [TICKET LOGIC] max_similarity: 0.XX
   [TICKET LOGIC] is_technical_issue: true/false
   [TICKET CREATION] Starting ticket creation process...
   [TICKET_SERVICE] Creating ticket with data: {...}
   [TICKET_SERVICE] Ticket created successfully: <ticket_id>
   ```

2. **Тестовые сценарии:**

   **Сценарий 1: AI явно запрашивает тикет**
   - Запрос: "Мне нужна помощь с настройкой роутера"
   - Ожидается: Тикет создается, даже если есть релевантная информация

   **Сценарий 2: Нет информации в базе знаний**
   - Запрос: "Как подключить спутниковое ТВ?"
   - Ожидается: Тикет создается (similarity < 0.2)

   **Сценарий 3: Техническая проблема**
   - Запрос: "Роутер не работает, нужен мастер"
   - Ожидается: Тикет создается

   **Сценарий 4: Есть информация, не техническая проблема**
   - Запрос: "Какие тарифы на интернет?"
   - Ожидается: Тикет НЕ создается, дается ответ из базы знаний

## Структура данных тикета

При создании тикета сохраняются:

```python
{
    "id": UUID,
    "source": "chat",
    "subject": "Первые 100 символов запроса",
    "description": "Полная история разговора",
    "status": "new",
    "priority": "high/medium/low" (из incoming_meta),
    "category": "network/telephony/tv/billing/equipment/other" (из incoming_meta),
    "subcategory": "..." (из incoming_meta),
    "language": "ru/kz" (из incoming_meta),
    "summary": "..." (из incoming_meta),
    "department_id": UUID (найден по имени из incoming_meta),
    "source_meta": {
        "user_id": "...",
        "client_type": "corporate/private",
        "category": "...",
        "subcategory": "...",
        "department": "...",
        "priority": "...",
        "confidence": 0.XX,
        ...
    }
}
```

## Отладка

Если тикеты все еще не создаются:

1. **Проверьте логи backend** - должны быть сообщения с префиксом `[TICKET`
2. **Проверьте ответ AI** - должен содержать блок `[TICKET_REQUIRED]` если нужен тикет
3. **Проверьте similarity** - если < 0.2, тикет должен создаваться
4. **Проверьте технические ключевые слова** - если есть в запросе, тикет должен создаваться
5. **Проверьте таблицу tickets в Supabase** - есть ли там новые записи

## Файлы, которые были изменены

1. `backend/app/api/v1/public_chat.py`
   - Улучшена логика принятия решения о создании тикета
   - Добавлено логирование

2. `backend/app/services/ticket_service.py`
   - Исправлено использование данных из `incoming_meta`
   - Добавлено преобразование `department` → `department_id`
   - Добавлено логирование

